name: Build Windows Executable

on:
  workflow_dispatch:  # 允许手动触发
  push:
    tags:
      - 'v*'  # 当推送tag时自动触发

jobs:
  build-exe:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Download ChromeDriver
      run: |
        # 创建drivers目录
        New-Item -ItemType Directory -Path "drivers" -Force | Out-Null
        
        # 尝试获取Chrome版本
        try {
          $chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          if (Test-Path $chromePath) {
            $versionInfo = (Get-Item $chromePath).VersionInfo
            $chromeVersion = "$($versionInfo.FileMajorPart).$($versionInfo.FileMinorPart).$($versionInfo.FileBuildPart)"
            Write-Host "检测到Chrome版本: $chromeVersion"
            $majorVersion = $versionInfo.FileMajorPart
          } else {
            Write-Host "Chrome未安装，使用最新版ChromeDriver"
            $majorVersion = "latest"
          }
        } catch {
          Write-Host "无法检测Chrome版本，使用最新版ChromeDriver"
          $majorVersion = "latest"
        }
        
        # 下载ChromeDriver
        try {
          if ($majorVersion -eq "latest") {
            # 使用Chrome for Testing API获取最新版本
            $versionUrl = "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json"
            $versionInfo = Invoke-RestMethod -Uri $versionUrl
            $driverVersion = $versionInfo.channels.Stable.version
            $driverUrl = $versionInfo.channels.Stable.downloads.chromedriver | Where-Object { $_.platform -eq "win64" } | Select-Object -ExpandProperty url
          } else {
            # 使用传统API
            $versionUrl = "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$majorVersion"
            try {
              $latestVersion = (Invoke-WebRequest -Uri $versionUrl -UseBasicParsing).Content.Trim()
              $driverUrl = "https://chromedriver.storage.googleapis.com/$latestVersion/chromedriver_win32.zip"
            } catch {
              # 如果失败，使用Chrome for Testing API
              $versionUrl = "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json"
              $versionInfo = Invoke-RestMethod -Uri $versionUrl
              $driverVersion = $versionInfo.channels.Stable.version
              $driverUrl = $versionInfo.channels.Stable.downloads.chromedriver | Where-Object { $_.platform -eq "win64" } | Select-Object -ExpandProperty url
            }
          }
          
          Write-Host "下载ChromeDriver: $driverUrl"
          $driverZip = "chromedriver.zip"
          Invoke-WebRequest -Uri $driverUrl -OutFile $driverZip
          Expand-Archive -Path $driverZip -DestinationPath "drivers" -Force
          Remove-Item $driverZip
          
          # 查找解压后的chromedriver.exe
          $chromedriver = Get-ChildItem -Path "drivers" -Filter "chromedriver.exe" -Recurse | Select-Object -First 1
          if ($chromedriver) {
            Move-Item -Path $chromedriver.FullName -Destination "drivers\chromedriver.exe" -Force
            # 删除其他文件
            Get-ChildItem -Path "drivers" -Exclude "chromedriver.exe" | Remove-Item -Recurse -Force
            Write-Host "ChromeDriver下载完成: drivers\chromedriver.exe"
          } else {
            Write-Host "警告: 未找到chromedriver.exe"
          }
        } catch {
          Write-Host "下载ChromeDriver失败: $_"
          Write-Host "将尝试使用webdriver-manager作为备选方案"
        }
        
    - name: Build executable
      run: |
        pyinstaller --onefile `
          --name LocalBlast `
          --add-data "templates;templates" `
          --add-data "species_db.json;." `
          --hidden-import=flask `
          --hidden-import=flask_cors `
          --hidden-import=werkzeug `
          --hidden-import=PIL `
          --hidden-import=selenium `
          --hidden-import=webdriver_manager `
          --console `
          blast_app.py
        
    - name: Create installer package
      run: |
        $packageName = "LocalBlast_Windows_Installer"
        $packageDir = "$packageName" + "_" + (Get-Date -Format "yyyyMMdd")
        New-Item -ItemType Directory -Path $packageDir -Force
        
        # Copy exe file
        Copy-Item dist\LocalBlast.exe $packageDir\
        
        # Copy necessary files
        Copy-Item species_db.json $packageDir\
        Copy-Item -Recurse templates $packageDir\templates
        
        # Copy ChromeDriver if exists
        if (Test-Path "drivers\chromedriver.exe") {
          Copy-Item drivers\chromedriver.exe $packageDir\
          Write-Host "已包含ChromeDriver到安装包"
        } else {
          Write-Host "警告: ChromeDriver未找到，PNG功能可能需要网络连接"
        }
        
        # Create 一键安装.bat
        $installScript = '@echo off' + "`n" +
          'chcp 65001 >nul' + "`n" +
          'title LocalBlast - 一键安装' + "`n" +
          'echo.' + "`n" +
          'echo ==========================================' + "`n" +
          'echo LocalBlast - 一键安装程序' + "`n" +
          'echo ==========================================' + "`n" +
          'echo.' + "`n" +
          'echo 此脚本将自动检查并安装所需环境' + "`n" +
          'echo.' + "`n" +
          'echo [1/2] 检查BLAST+工具...' + "`n" +
          'echo.' + "`n" +
          'where blastn >nul 2>&1' + "`n" +
          'if %errorLevel% neq 0 (' + "`n" +
          '    echo [×] 未找到BLAST+工具' + "`n" +
          '    echo.' + "`n" +
          '    echo 请安装BLAST+工具：' + "`n" +
          '    echo 1. 访问 https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/LATEST/' + "`n" +
          '    echo 2. 下载Windows版本（如：ncbi-blast-*-win64.exe）' + "`n" +
          '    echo 3. 运行安装程序，安装时选择"Add to PATH"' + "`n" +
          '    echo 4. 安装完成后重新运行此脚本' + "`n" +
          '    echo.' + "`n" +
          '    pause' + "`n" +
          '    exit /b 1' + "`n" +
          ')' + "`n" +
          'blastn -version' + "`n" +
          'echo [√] BLAST+已安装' + "`n" +
          'echo.' + "`n" +
          'echo [2/2] 环境检查完成！' + "`n" +
          'echo.' + "`n" +
          'echo ==========================================' + "`n" +
          'echo 安装完成！' + "`n" +
          'echo ==========================================' + "`n" +
          'echo.' + "`n" +
          'echo 现在可以：' + "`n" +
          'echo 1. 双击运行 "启动LocalBlast.bat" 启动程序' + "`n" +
          'echo 2. 在浏览器中访问 http://localhost:5001' + "`n" +
          'echo.' + "`n" +
          'pause'
        [System.IO.File]::WriteAllText("$packageDir\一键安装.bat", $installScript, [System.Text.Encoding]::UTF8)
        
        # Create 启动LocalBlast.bat
        $startScript = '@echo off' + "`n" +
          'chcp 65001 >nul' + "`n" +
          'title LocalBlast - 本地BLAST工具' + "`n" +
          'echo.' + "`n" +
          'echo ==========================================' + "`n" +
          'echo LocalBlast - 本地BLAST工具' + "`n" +
          'echo ==========================================' + "`n" +
          'echo.' + "`n" +
          'echo 正在启动服务...' + "`n" +
          'echo.' + "`n" +
          'echo 服务地址: http://localhost:5001' + "`n" +
          'echo.' + "`n" +
          'echo 提示：' + "`n" +
          'echo - 保持此窗口打开以运行服务' + "`n" +
          'echo - 关闭此窗口将停止服务' + "`n" +
          'echo - 按 Ctrl+C 也可以停止服务' + "`n" +
          'echo.' + "`n" +
          'echo ==========================================' + "`n" +
          'echo.' + "`n" +
          'LocalBlast.exe' + "`n" +
          'pause'
        [System.IO.File]::WriteAllText("$packageDir\启动LocalBlast.bat", $startScript, [System.Text.Encoding]::UTF8)
        
        # Create 使用说明.txt
        $readme = 'LocalBlast Windows 可执行文件安装包' + "`n`n" +
          '==========================================' + "`n" +
          '快速开始' + "`n" +
          '==========================================' + "`n`n" +
          '1. 双击运行 "一键安装.bat" 检查环境' + "`n" +
          '2. 双击运行 "启动LocalBlast.bat" 启动程序' + "`n" +
          '3. 在浏览器中访问 http://localhost:5001' + "`n`n" +
          '==========================================' + "`n" +
          '系统要求' + "`n" +
          '==========================================' + "`n`n" +
          '1. BLAST+工具 （从 https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/LATEST/ 下载）' + "`n`n" +
          '注意：本exe文件已包含所有Python依赖，不需要安装Python。' + "`n`n" +
          '==========================================' + "`n" +
          '文件说明' + "`n" +
          '==========================================' + "`n`n" +
          '- LocalBlast.exe: 主程序（已包含所有Python依赖）' + "`n" +
          '- 一键安装.bat: 环境检查脚本' + "`n" +
          '- 启动LocalBlast.bat: 启动程序脚本' + "`n" +
          '- species_db.json: 参比序列数据库' + "`n" +
          '- templates/: HTML模板文件夹' + "`n`n" +
          '==========================================' + "`n" +
          '注意事项' + "`n" +
          '==========================================' + "`n`n" +
          '1. 首次使用前请先运行"一键安装.bat"检查环境' + "`n" +
          '2. BLAST+工具需要单独安装（无法打包到exe中）' + "`n" +
          '3. 如果遇到问题，请查看错误提示或联系技术支持'
        [System.IO.File]::WriteAllText("$packageDir\使用说明.txt", $readme, [System.Text.Encoding]::UTF8)
        
    - name: Create ZIP archive
      run: |
        $packageDir = "LocalBlast_Windows_Installer_" + (Get-Date -Format "yyyyMMdd")
        Compress-Archive -Path $packageDir -DestinationPath "$packageDir.zip" -Force
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: LocalBlast-Windows-Installer
        path: LocalBlast_Windows_Installer_*.zip
        retention-days: 30
        
    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: LocalBlast_Windows_Installer_*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
