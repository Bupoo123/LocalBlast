name: Build Windows Executable

on:
  workflow_dispatch:  # 允许手动触发
  push:
    tags:
      - 'v*'  # 当推送tag时自动触发

jobs:
  build-exe:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable
      run: |
        pyinstaller --onefile `
          --name LocalBlast `
          --add-data "templates;templates" `
          --add-data "species_db.json;." `
          --hidden-import=flask `
          --hidden-import=flask_cors `
          --hidden-import=werkzeug `
          --hidden-import=PIL `
          --hidden-import=selenium `
          --hidden-import=webdriver_manager `
          --console `
          blast_app.py
        
    - name: Create installer package
      run: |
        $packageName = "LocalBlast_Windows_Installer"
        $packageDir = "$packageName" + "_" + (Get-Date -Format "yyyyMMdd")
        New-Item -ItemType Directory -Path $packageDir -Force
        
        # Copy exe file
        Copy-Item dist\LocalBlast.exe $packageDir\
        
        # Copy necessary files
        Copy-Item species_db.json $packageDir\
        Copy-Item -Recurse templates $packageDir\templates
        
        # Create 一键安装.bat
        $installScript = @"
@echo off
chcp 65001 >nul
title LocalBlast - 一键安装
echo.
echo ==========================================
echo LocalBlast - 一键安装程序
echo ==========================================
echo.
echo 此脚本将自动检查并安装所需环境
echo.
echo [1/2] 检查BLAST+工具...
echo.
where blastn >nul 2>&1
if %errorLevel% neq 0 (
    echo [×] 未找到BLAST+工具
    echo.
    echo 请安装BLAST+工具：
    echo 1. 访问 https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/LATEST/
    echo 2. 下载Windows版本（如：ncbi-blast-*-win64.exe）
    echo 3. 运行安装程序，安装时选择"Add to PATH"
    echo 4. 安装完成后重新运行此脚本
    echo.
    pause
    exit /b 1
)
blastn -version
echo [√] BLAST+已安装
echo.
echo [2/2] 环境检查完成！
echo.
echo ==========================================
echo 安装完成！
echo ==========================================
echo.
echo 现在可以：
echo 1. 双击运行 "启动LocalBlast.bat" 启动程序
echo 2. 在浏览器中访问 http://localhost:5001
echo.
pause
"@
        Set-Content -Path "$packageDir\一键安装.bat" -Value $installScript -Encoding UTF8
        
        # Create 启动LocalBlast.bat
        $startScript = @"
@echo off
chcp 65001 >nul
title LocalBlast - 本地BLAST工具
echo.
echo ==========================================
echo LocalBlast - 本地BLAST工具
echo ==========================================
echo.
echo 正在启动服务...
echo.
echo 服务地址: http://localhost:5001
echo.
echo 提示：
echo - 保持此窗口打开以运行服务
echo - 关闭此窗口将停止服务
echo - 按 Ctrl+C 也可以停止服务
echo.
echo ==========================================
echo.
LocalBlast.exe
pause
"@
        Set-Content -Path "$packageDir\启动LocalBlast.bat" -Value $startScript -Encoding UTF8
        
        # Create 使用说明.txt
        $readme = @"
LocalBlast Windows 可执行文件安装包

==========================================
快速开始
==========================================

1. 双击运行 "一键安装.bat" 检查环境
2. 双击运行 "启动LocalBlast.bat" 启动程序
3. 在浏览器中访问 http://localhost:5001

==========================================
系统要求
==========================================

1. BLAST+工具 （从 https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/LATEST/ 下载）

注意：本exe文件已包含所有Python依赖，不需要安装Python。

==========================================
文件说明
==========================================

- LocalBlast.exe: 主程序（已包含所有Python依赖）
- 一键安装.bat: 环境检查脚本
- 启动LocalBlast.bat: 启动程序脚本
- species_db.json: 参比序列数据库
- templates/: HTML模板文件夹

==========================================
注意事项
==========================================

1. 首次使用前请先运行"一键安装.bat"检查环境
2. BLAST+工具需要单独安装（无法打包到exe中）
3. 如果遇到问题，请查看错误提示或联系技术支持
"@
        Set-Content -Path "$packageDir\使用说明.txt" -Value $readme -Encoding UTF8
        
    - name: Create ZIP archive
      run: |
        $packageDir = "LocalBlast_Windows_Installer_" + (Get-Date -Format "yyyyMMdd")
        Compress-Archive -Path $packageDir -DestinationPath "$packageDir.zip" -Force
        
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: LocalBlast-Windows-Installer
        path: LocalBlast_Windows_Installer_*.zip
        retention-days: 30
        
    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: LocalBlast_Windows_Installer_*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
