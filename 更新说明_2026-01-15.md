# LocalBlast 更新说明 - 2026年1月15日

## 📋 本次更新概览

本次更新为LocalBlast工具添加了多项新功能和改进，包括macOS支持、PNG图片生成、序列模板下载、参比序列更新以及Windows可执行文件打包功能。

---

## ✨ 新增功能

### 1. 🍎 macOS系统支持

**功能说明：**
- 新增macOS一键启动脚本 `start_blast.command`
- macOS用户现在可以像Windows用户一样，双击文件即可启动程序

**使用方法：**
- 在Finder中找到 `start_blast.command` 文件
- 双击运行（首次可能需要右键 → "打开" 来授权）
- 等待服务启动，在浏览器中访问 http://localhost:5001

**优势：**
- 无需打开终端
- 自动检查环境（Python、BLAST+、依赖）
- 自动安装缺失的依赖
- 友好的错误提示

---

### 2. 🖼️ PNG图片生成功能

**功能说明：**
- 批量处理时，除了生成HTML结果文件外，还会自动生成对应的PNG图片文件
- PNG图片会自动裁剪空白部分，只保留有内容的部分
- 图片添加了10像素边距，确保内容不会贴边

**使用方法：**
- 使用批量处理功能上传.seq文件
- 处理完成后，下载的ZIP文件中会包含：
  - `.html` 文件（完整HTML结果）
  - `.png` 文件（裁剪后的图片）

**系统要求：**
- 需要安装Chrome浏览器（用于WebDriver）
- 如果系统没有Chrome，PNG生成会失败，但HTML文件仍会正常生成

**注意事项：**
- PNG生成会增加处理时间（每个文件约1-2秒）
- 首次运行需要下载ChromeDriver（需要网络连接）
- PNG生成失败不影响HTML文件生成

---

### 3. 📥 序列文件模板下载

**功能说明：**
- 在批量上传页面添加了"下载模板文件"功能
- 提供包含3个示例序列的模板文件（`sequence_template.seq`）
- 方便用户了解.seq文件的格式要求

**使用方法：**
1. 访问批量上传页面（http://localhost:5001/batch）
2. 点击"📥 下载模板文件（sequence_template.seq）"
3. 下载后查看格式，参考创建自己的.seq文件

**模板内容：**
```
>1
AAACTTTTTGATCAATGGGGGACGAAGCCTCATGATGACTGCAGAATCTGAATCGCTTGAT
>2
ACGCGATTTTAAAGACCGCGTCGGCTTTCTTCGCGGCCGAGCTCGACCGGCCAGCACGCTAATTAACGGTTCATCGCC
>3
AAGTATTGCACAGAGGGGAAGAAAAGGATAGTGACGATGTATTAAGAGAATTAAATAGACAACCTTTGAACCTTCAGGCTAAAGAAGGTTTAGC
```

---

### 4. 🧬 参比序列数据库更新

**更新内容：**
- 参比序列数量从97条增加到**128条**
- 新增了多种病原体参比序列
- 更新了序列数据，确保准确性

**更新工具：**
- 新增 `update_species_db.py` 脚本
- 可以从Excel文件（`参比序列-20260114.xlsx`）自动更新数据库
- 自动备份原数据库文件

**使用方法（更新参比序列）：**
```bash
python3 update_species_db.py
```

**注意事项：**
- 更新后需要重启后端才能生效
- 原数据库会自动备份为 `species_db.json.backup`

---

### 5. 📦 Windows可执行文件打包功能

**功能说明：**
- 支持将Python应用打包成Windows可执行文件（.exe）
- 包含所有Python依赖，用户无需安装Python依赖
- 通过GitHub Actions自动打包，无需Windows系统

**使用方法（自动打包）：**
1. 访问GitHub Actions页面：https://github.com/Bupoo123/LocalBlast/actions
2. 点击"Build Windows Executable"
3. 点击"Run workflow"触发打包
4. 等待5-10分钟，下载打包结果

**打包结果包含：**
- `LocalBlast.exe` - 主程序（包含所有Python依赖）
- `一键安装.bat` - 环境检查脚本
- `启动LocalBlast.bat` - 启动程序脚本
- `使用说明.txt` - 使用说明
- `species_db.json` - 参比序列数据库（128条）
- `templates/` - HTML模板文件夹

**优势：**
- 用户无需安装Python依赖
- 一键启动，使用简单
- 适合IT基础较弱的用户

---

## 🔧 技术改进

### 1. 错误处理优化
- 改进了依赖检查机制
- selenium和Pillow设为可选依赖，未安装时不会导致程序启动失败
- 更友好的错误提示信息

### 2. 代码优化
- 优化了HTML转PNG的代码
- 改进了ChromeDriver路径查找逻辑
- 修复了webdriver-manager的路径问题

### 3. 文档完善
- 添加了macOS使用说明
- 添加了打包和分发指南
- 更新了README文档

---

## ⚠️ 重要注意事项

### 1. 重启后端
**必须操作：**
- 更新参比序列后，**必须重启后端**才能加载新数据
- 重启方法：停止当前运行的程序（Ctrl+C），然后重新启动

### 2. PNG生成功能
**系统要求：**
- 需要安装Chrome浏览器
- 首次运行需要网络连接（下载ChromeDriver）
- 如果Chrome未安装，PNG生成会失败，但HTML文件仍会正常生成

**macOS用户额外说明：**
- 如果chromedriver没有执行权限，需要运行：
  ```bash
  chmod +x ~/.wdm/drivers/chromedriver/mac64/*/chromedriver-mac-arm64/chromedriver
  ```

### 3. Windows可执行文件
**限制：**
- BLAST+工具无法打包到exe中，用户必须单独安装
- 打包需要在Windows系统上完成（或使用GitHub Actions）

### 4. 依赖安装
**可选依赖：**
- selenium和Pillow是可选的
- 如果未安装，程序仍可正常运行，只是PNG生成功能不可用

---

## 📝 使用建议

### 对于Windows用户（使用exe版本）

1. **安装BLAST+工具**（必须）
   - 下载：https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/LATEST/
   - 安装时选择"Add to PATH"

2. **解压并运行**
   - 解压下载的ZIP文件
   - 双击运行 `一键安装.bat`（检查环境）
   - 双击运行 `启动LocalBlast.bat`（启动程序）
   - 在浏览器中访问 http://localhost:5001

### 对于macOS用户

1. **安装BLAST+工具**
   ```bash
   brew install blast
   ```

2. **启动程序**
   - 双击运行 `start_blast.command`
   - 或在终端运行：`./start_blast.command`

### 对于需要更新参比序列的用户

1. **准备Excel文件**
   - 确保Excel文件包含：流水号、靶点名称、编号、参比序列、序列大小

2. **运行更新脚本**
   ```bash
   python3 update_species_db.py
   ```

3. **重启后端**
   - 停止当前程序
   - 重新启动程序

---

## 🐛 已知问题

1. **PNG生成失败**
   - 如果系统没有Chrome浏览器，PNG生成会失败
   - 解决方案：安装Chrome浏览器，或只使用HTML文件

2. **ChromeDriver权限问题（macOS）**
   - 首次使用可能需要添加执行权限
   - 解决方案：运行 `chmod +x` 命令

3. **打包时间较长**
   - GitHub Actions打包需要5-10分钟
   - 这是正常的，请耐心等待

---

## 📚 相关文档

- **README.md** - 项目说明和快速开始
- **WINDOWS_INSTALL.md** - Windows详细安装指南
- **使用GitHub自动打包说明.md** - GitHub Actions打包说明
- **分发指南_可执行文件版.md** - 可执行文件分发指南
- **在Windows上打包说明.md** - Windows本地打包说明

---

## 🎉 总结

本次更新为LocalBlast工具带来了：
- ✅ macOS系统支持
- ✅ PNG图片生成功能
- ✅ 序列模板下载功能
- ✅ 参比序列数据库更新（128条）
- ✅ Windows可执行文件打包功能

所有功能都已经过测试，可以正常使用。如有问题，请查看相关文档或联系技术支持。

---

**更新日期：** 2026年1月15日  
**版本：** 基于最新main分支  
**GitHub仓库：** https://github.com/Bupoo123/LocalBlast
